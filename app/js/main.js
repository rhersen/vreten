var json = {
    "buses": [
        {
            "JourneyDirection": 1,
            "GroupOfLine": null,
            "StopAreaName": "Karlbergs station",
            "StopAreaNumber": 10135,
            "StopPointNumber": 10175,
            "StopPointDesignation": null,
            "TimeTabledDateTime": "2015-06-26T18:05:00",
            "ExpectedDateTime": "2015-06-26T18:05:00",
            "DisplayTime": "18:05",
            "Deviations": null,
            "TransportMode": "BUS",
            "LineNumber": "72",
            "Destination": "Frihamnen",
            "SiteId": 9510
        },
        {
            "JourneyDirection": 1,
            "GroupOfLine": null,
            "StopAreaName": "Karlbergs station",
            "StopAreaNumber": 10135,
            "StopPointNumber": 10173,
            "StopPointDesignation": null,
            "TimeTabledDateTime": "2015-06-26T18:08:00",
            "ExpectedDateTime": "2015-06-26T18:08:00",
            "DisplayTime": "3 min",
            "Deviations": null,
            "TransportMode": "BUS",
            "LineNumber": "507",
            "Destination": "Tomteboda postterminal",
            "SiteId": 9510
        },
        {
            "JourneyDirection": 1,
            "GroupOfLine": null,
            "StopAreaName": "Karlbergs station",
            "StopAreaNumber": 10135,
            "StopPointNumber": 10175,
            "StopPointDesignation": null,
            "TimeTabledDateTime": "2015-06-26T18:20:00",
            "ExpectedDateTime": "2015-06-26T18:20:00",
            "DisplayTime": "18:20",
            "Deviations": null,
            "TransportMode": "BUS",
            "LineNumber": "72",
            "Destination": "Frihamnen",
            "SiteId": 9510
        },
        {
            "JourneyDirection": 1,
            "GroupOfLine": null,
            "StopAreaName": "Karlbergs station",
            "StopAreaNumber": 10135,
            "StopPointNumber": 10175,
            "StopPointDesignation": null,
            "TimeTabledDateTime": "2015-06-26T18:35:00",
            "ExpectedDateTime": "2015-06-26T18:35:00",
            "DisplayTime": "18:35",
            "Deviations": null,
            "TransportMode": "BUS",
            "LineNumber": "72",
            "Destination": "Frihamnen",
            "SiteId": 9510
        },
        {
            "JourneyDirection": 1,
            "GroupOfLine": null,
            "StopAreaName": "Karlbergs station",
            "StopAreaNumber": 10135,
            "StopPointNumber": 10173,
            "StopPointDesignation": null,
            "TimeTabledDateTime": "2015-06-26T18:38:00",
            "ExpectedDateTime": "2015-06-26T18:38:00",
            "DisplayTime": "18:38",
            "Deviations": null,
            "TransportMode": "BUS",
            "LineNumber": "507",
            "Destination": "Tomteboda postterminal",
            "SiteId": 9510
        },
        {
            "JourneyDirection": 1,
            "GroupOfLine": null,
            "StopAreaName": "Karlbergs station",
            "StopAreaNumber": 10135,
            "StopPointNumber": 10175,
            "StopPointDesignation": null,
            "TimeTabledDateTime": "2015-06-26T18:50:00",
            "ExpectedDateTime": "2015-06-26T18:50:00",
            "DisplayTime": "18:50",
            "Deviations": null,
            "TransportMode": "BUS",
            "LineNumber": "72",
            "Destination": "Frihamnen",
            "SiteId": 9510
        }
    ],
    "stoppointdeviations": [
        {
            "StopInfo": {
                "StopAreaNumber": 0,
                "StopAreaName": "Karlberg",
                "TransportMode": "TRAIN",
                "GroupOfLine": null
            },
            "Deviation": {
                "Text": "Buss ersätter Västerhaninge-Nynäshamn 22/6-2/8 och Spånga-Bålsta 27/6-2/8 pga banarbeten. Se sl.se",
                "Consequence": null,
                "ImportanceLevel": 5
            }
        }
    ],
    "trains": [
        {
            "JourneyDirection": 2,
            "SecondaryDestinationName": null,
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5022,
            "StopPointDesignation": "3",
            "TimeTabledDateTime": "2015-06-26T18:04:00",
            "ExpectedDateTime": "2015-06-26T18:04:00",
            "DisplayTime": "Nu",
            "Deviations": null,
            "TransportMode": "TRAIN",
            "LineNumber": "36",
            "Destination": "Märsta",
            "SiteId": 9510,
            "Key": "18042"
        },
        {
            "JourneyDirection": 1,
            "SecondaryDestinationName": "Stockholm C",
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5021,
            "StopPointDesignation": "2",
            "TimeTabledDateTime": "2015-06-26T18:10:00",
            "ExpectedDateTime": "2015-06-26T18:10:00",
            "DisplayTime": "5 min",
            "Deviations": null,
            "TransportMode": "TRAIN",
            "LineNumber": "36",
            "Destination": "Södertälje C",
            "SiteId": 9510,
            "Key": "18101"
        },
        {
            "JourneyDirection": 2,
            "SecondaryDestinationName": "Arlanda C",
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5022,
            "StopPointDesignation": "3",
            "TimeTabledDateTime": "2015-06-26T18:12:00",
            "ExpectedDateTime": "2015-06-26T18:12:00",
            "DisplayTime": "7 min",
            "Deviations": [
                {
                    "Text": "Resa förbi Arlanda C kräver både UL- och SL- biljett.",
                    "Consequence": "INFORMATION",
                    "ImportanceLevel": 5
                }
            ],
            "TransportMode": "TRAIN",
            "LineNumber": "38",
            "Destination": "Uppsala C",
            "SiteId": 9510,
            "Key": "18122"
        },
        {
            "JourneyDirection": 1,
            "SecondaryDestinationName": "Stockholm C",
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5021,
            "StopPointDesignation": "2",
            "TimeTabledDateTime": "2015-06-26T18:13:00",
            "ExpectedDateTime": "2015-06-26T18:13:00",
            "DisplayTime": "8 min",
            "Deviations": null,
            "TransportMode": "TRAIN",
            "LineNumber": "35",
            "Destination": "Västerhaninge",
            "SiteId": 9510,
            "Key": "18131"
        },
        {
            "JourneyDirection": 1,
            "SecondaryDestinationName": "Stockholm C",
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5021,
            "StopPointDesignation": "2",
            "TimeTabledDateTime": "2015-06-26T18:17:00",
            "ExpectedDateTime": "2015-06-26T18:17:00",
            "DisplayTime": "12 min",
            "Deviations": null,
            "TransportMode": "TRAIN",
            "LineNumber": "38",
            "Destination": "Tumba",
            "SiteId": 9510,
            "Key": "18171"
        },
        {
            "JourneyDirection": 2,
            "SecondaryDestinationName": null,
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5022,
            "StopPointDesignation": "3",
            "TimeTabledDateTime": "2015-06-26T18:16:00",
            "ExpectedDateTime": "2015-06-26T18:18:32",
            "DisplayTime": "13 min",
            "Deviations": null,
            "TransportMode": "TRAIN",
            "LineNumber": "35",
            "Destination": "Kungsängen",
            "SiteId": 9510,
            "Key": "18162"
        },
        {
            "JourneyDirection": 2,
            "SecondaryDestinationName": null,
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5022,
            "StopPointDesignation": "3",
            "TimeTabledDateTime": "2015-06-26T18:19:00",
            "ExpectedDateTime": "2015-06-26T18:19:00",
            "DisplayTime": "14 min",
            "Deviations": null,
            "TransportMode": "TRAIN",
            "LineNumber": "36",
            "Destination": "Märsta",
            "SiteId": 9510,
            "Key": "18192"
        },
        {
            "JourneyDirection": 1,
            "SecondaryDestinationName": "Stockholm C",
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5021,
            "StopPointDesignation": "2",
            "TimeTabledDateTime": "2015-06-26T18:25:00",
            "ExpectedDateTime": "2015-06-26T18:25:00",
            "DisplayTime": "20 min",
            "Deviations": null,
            "TransportMode": "TRAIN",
            "LineNumber": "36",
            "Destination": "Södertälje C",
            "SiteId": 9510,
            "Key": "18251"
        },
        {
            "JourneyDirection": 1,
            "SecondaryDestinationName": "Stockholm C",
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5021,
            "StopPointDesignation": "2",
            "TimeTabledDateTime": "2015-06-26T18:28:00",
            "ExpectedDateTime": "2015-06-26T18:28:00",
            "DisplayTime": "23 min",
            "Deviations": null,
            "TransportMode": "TRAIN",
            "LineNumber": "35",
            "Destination": "Västerhaninge",
            "SiteId": 9510,
            "Key": "18281"
        },
        {
            "JourneyDirection": 2,
            "SecondaryDestinationName": null,
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5022,
            "StopPointDesignation": "3",
            "TimeTabledDateTime": "2015-06-26T18:31:00",
            "ExpectedDateTime": "2015-06-26T18:31:00",
            "DisplayTime": "26 min",
            "Deviations": null,
            "TransportMode": "TRAIN",
            "LineNumber": "35",
            "Destination": "Bålsta",
            "SiteId": 9510,
            "Key": "18312"
        },
        {
            "JourneyDirection": 2,
            "SecondaryDestinationName": null,
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5022,
            "StopPointDesignation": "3",
            "TimeTabledDateTime": "2015-06-26T18:34:00",
            "ExpectedDateTime": "2015-06-26T18:34:00",
            "DisplayTime": "29 min",
            "Deviations": null,
            "TransportMode": "TRAIN",
            "LineNumber": "36",
            "Destination": "Märsta",
            "SiteId": 9510,
            "Key": "18342"
        },
        {
            "JourneyDirection": 1,
            "SecondaryDestinationName": "Stockholm C",
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5021,
            "StopPointDesignation": "2",
            "TimeTabledDateTime": "2015-06-26T18:40:00",
            "ExpectedDateTime": "2015-06-26T18:40:00",
            "DisplayTime": "18:40",
            "Deviations": null,
            "TransportMode": "TRAIN",
            "LineNumber": "36",
            "Destination": "Södertälje C",
            "SiteId": 9510,
            "Key": "18401"
        },
        {
            "JourneyDirection": 2,
            "SecondaryDestinationName": "Arlanda C",
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5022,
            "StopPointDesignation": "3",
            "TimeTabledDateTime": "2015-06-26T18:42:00",
            "ExpectedDateTime": "2015-06-26T18:42:00",
            "DisplayTime": "18:42",
            "Deviations": [
                {
                    "Text": "Resa förbi Arlanda C kräver både UL- och SL- biljett.",
                    "Consequence": "INFORMATION",
                    "ImportanceLevel": 5
                }
            ],
            "TransportMode": "TRAIN",
            "LineNumber": "38",
            "Destination": "Uppsala C",
            "SiteId": 9510,
            "Key": "18422"
        },
        {
            "JourneyDirection": 1,
            "SecondaryDestinationName": "Stockholm C",
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5021,
            "StopPointDesignation": "2",
            "TimeTabledDateTime": "2015-06-26T18:43:00",
            "ExpectedDateTime": "2015-06-26T18:43:00",
            "DisplayTime": "18:43",
            "Deviations": null,
            "TransportMode": "TRAIN",
            "LineNumber": "35",
            "Destination": "Västerhaninge",
            "SiteId": 9510,
            "Key": "18431"
        },
        {
            "JourneyDirection": 2,
            "SecondaryDestinationName": null,
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5022,
            "StopPointDesignation": "3",
            "TimeTabledDateTime": "2015-06-26T18:46:00",
            "ExpectedDateTime": "2015-06-26T18:46:00",
            "DisplayTime": "18:46",
            "Deviations": null,
            "TransportMode": "TRAIN",
            "LineNumber": "35",
            "Destination": "Kungsängen",
            "SiteId": 9510,
            "Key": "18462"
        },
        {
            "JourneyDirection": 1,
            "SecondaryDestinationName": "Stockholm C",
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5021,
            "StopPointDesignation": "2",
            "TimeTabledDateTime": "2015-06-26T18:47:00",
            "ExpectedDateTime": "2015-06-26T18:47:00",
            "DisplayTime": "18:47",
            "Deviations": null,
            "TransportMode": "TRAIN",
            "LineNumber": "38",
            "Destination": "Älvsjö",
            "SiteId": 9510,
            "Key": "18471"
        },
        {
            "JourneyDirection": 2,
            "SecondaryDestinationName": null,
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5022,
            "StopPointDesignation": "3",
            "TimeTabledDateTime": "2015-06-26T18:49:00",
            "ExpectedDateTime": "2015-06-26T18:49:00",
            "DisplayTime": "18:49",
            "Deviations": null,
            "TransportMode": "TRAIN",
            "LineNumber": "36",
            "Destination": "Märsta",
            "SiteId": 9510,
            "Key": "18492"
        },
        {
            "JourneyDirection": 1,
            "SecondaryDestinationName": "Stockholm C",
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5021,
            "StopPointDesignation": "2",
            "TimeTabledDateTime": "2015-06-26T18:55:00",
            "ExpectedDateTime": "2015-06-26T18:55:00",
            "DisplayTime": "18:55",
            "Deviations": null,
            "TransportMode": "TRAIN",
            "LineNumber": "36",
            "Destination": "Södertälje C",
            "SiteId": 9510,
            "Key": "18551"
        },
        {
            "JourneyDirection": 1,
            "SecondaryDestinationName": "Stockholm C",
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5021,
            "StopPointDesignation": "2",
            "TimeTabledDateTime": "2015-06-26T18:58:00",
            "ExpectedDateTime": "2015-06-26T18:58:00",
            "DisplayTime": "18:58",
            "Deviations": null,
            "TransportMode": "TRAIN",
            "LineNumber": "35",
            "Destination": "Västerhaninge",
            "SiteId": 9510,
            "Key": "18581"
        },
        {
            "JourneyDirection": 2,
            "SecondaryDestinationName": null,
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5022,
            "StopPointDesignation": "3",
            "TimeTabledDateTime": "2015-06-26T19:01:00",
            "ExpectedDateTime": "2015-06-26T19:01:00",
            "DisplayTime": "19:01",
            "Deviations": null,
            "TransportMode": "TRAIN",
            "LineNumber": "35",
            "Destination": "Bålsta",
            "SiteId": 9510,
            "Key": "19012"
        },
        {
            "JourneyDirection": 2,
            "SecondaryDestinationName": null,
            "StopAreaName": "Karlberg",
            "StopAreaNumber": 5021,
            "StopPointNumber": 5022,
            "StopPointDesignation": "3",
            "TimeTabledDateTime": "2015-06-26T19:04:00",
            "ExpectedDateTime": "2015-06-26T19:04:00",
            "DisplayTime": "19:04",
            "Deviations": null,
            "TransportMode": "TRAIN",
            "LineNumber": "36",
            "Destination": "Märsta",
            "SiteId": 9510,
            "Key": "19042"
        }
    ],
    "StopAreaName": "Karlberg",
    "SiteId": 9510
};

window.southwest = function (json) {
    var southbound = _.filter(json.trains, {JourneyDirection: 1});
    var westbound = _.filter(southbound, function (train) {
        return _.contains(["36", "38"], train.LineNumber);
    });
    return _.reject(westbound, {Destination: 'Älvsjö'});
};

window.southeast = function (json) {
    var southbound = _.filter(json.trains, {JourneyDirection: 1});
    var eastbound = _.filter(southbound, function (train) {
        return _.contains(["35"], train.LineNumber);
    });
    return _.reject(eastbound, {Destination: 'Älvsjö'});
};

window.findConnecting = function (train, southwest) {
    return _.find(southwest, function (t) {
        return t.ExpectedDateTime > train.ExpectedDateTime;
    });
};

window.diff = function (train1, train2) {
    var regExp = /(..):(..):(..)/;
    var m1 = regExp.exec(train1.ExpectedDateTime);
    var m2 = regExp.exec(train2.ExpectedDateTime);
    var min = m1[2] - m2[2];
    var sec = m1[3] - m2[3];
    var hour = m1[1] !== m2[1];
    return 3600 * hour + 60 * min + sec;
};

window.showTrain = function (train, sw) {
    var no = JST['app/templates/no-connection.us'];
    var good = JST['app/templates/good-connection.us'];
    var bad = JST['app/templates/bad-connection.us'];
    var matching = findConnecting(train, sw);
    if (matching) {
        var seconds = diff(matching, train);
        return (seconds < 500 ? good : bad)({
            fromExpectedDateTime: train.ExpectedDateTime,
            fromDestination: train.Destination,
            toExpectedDateTime: matching.ExpectedDateTime,
            toDestination: matching.Destination,
            diff: seconds
        });
    } else {
        return no(train);
    }
};

window.init = function () {
    function showTrains(json) {
        var sw = southwest(json);
        var s = '<table>';
        s += '<tr>';
        s += '<th>Till Karlberg</th>';
        s += '<th>Från Karlberg</th>';
        s += '<th>Byte (sekunder)</th>';
        s += '</tr>';
        _.forEach(southeast(json), function (train) {
            s += showTrain(train, sw);
        });
        s += '</table>';
        document.body.innerHTML += s;
    }

    var request = new XMLHttpRequest();
    request.open('GET', 'departures/9510', true);

    request.onload = function () {
        if (this.status >= 200 && this.status < 400) {
            showTrains(JSON.parse(this.response));
        } else {
            document.body.innerHTML += '<strong>' + this.statusText + '</strong>';
        }
    };

    request.onerror = function () {
        console.log(request);
        document.body.innerHTML += '<strong>There was a connection error of some sort</strong>';
    };

    if (request) {
        request.send();
    } else {
        showTrains(json);
    }
};
